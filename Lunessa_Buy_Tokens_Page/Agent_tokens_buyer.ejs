<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Token Purchase - Professional</title>
    <link rel="stylesheet" href="main.css">
    <link rel="stylesheet" href="agent-model-viewer.css">
    <!-- loading the agentId -->
    <script>
        const selectedAgent = "<%= selectedAgent %>";
        window.selectedAgent = selectedAgent;
        console.log("Selected Agent ID:", selectedAgent);
    </script>
    <!-- JavaScript Modules -->
    <script src="utils/config.js"></script>
    <script src="utils/calculation.js"></script>
    <script src="utils/base_discount.js"></script>
    <script src="utils/offers.js"></script>
    <script src="utils/ui.js"></script>
    <script src="utils/main.js"></script>
    <script src="utils/get_offers_from_admin.js"></script>
    <script src="utils/verify_coupons_from_customer.js"></script>
    <script src="utils/calculate_coupons.js"></script>
    <script src="utils/get_AI_model_pricing_data_from_admin.js"></script>
    
    <!-- Agent Model Viewer -->
    <script src="utils/agent-model-viewer/AgentModelViewer.js"></script>
    <script src="utils/agent-model-viewer/get_agent_token_details.js"></script>
    <script src="utils/agent-model-viewer/EventHandler.js"></script>
    <script src="utils/agent-model-viewer/UIManager.js"></script>
    <script src="utils/agent-model-viewer/Utils.js"></script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>AI TOKEN MARKETPLACE</h1>
        </div>

        <div class="info-cards">
            <div class="agent-card">
                <div class="card-header">
                    <div class="icon">ü§ñ</div>
                    <h3>Agent Information</h3>
                </div>
                <div class="card-content">
                    <p class="agent-name">MZK- AI</p>
                    <span class="status-badge">Active</span>
                </div>
            </div>
            <div class="token-card">
                <div class="card-header">
                    <div class="icon">‚ö°</div>
                    <h3>Available Tokens</h3>
                </div>
                <div class="card-content">
                    <p class="token-count">5,000</p>
                    <span class="availability">Ready for Purchase</span>
                </div>
            </div>
        </div>

        <!-- Agent Model Viewer -->
        <div class="agent-model-viewer">
            <div class="viewer-header" id="viewerHeader">
                <div class="viewer-title">
                    <div class="viewer-icon">ü§ñ</div>
                    <h3>AGENT MODEL VIEWER</h3>
                </div>
                <button class="viewer-toggle" id="viewerToggle">
                    <svg class="arrow-icon" width="12" height="8" viewBox="0 0 12 8" fill="none">
                        <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="viewer-content" id="viewerContent" style="display: none;">
                <div class="agents-grid" id="agentsGrid">
                    <!-- Agents will be populated here -->
                </div>
            </div>
        </div>

        <div class="purchase-section">
            <div class="section-header">
                <h2>Configure Your Purchase</h2>
                <p>Select your preferred AI model and specify the number of tokens needed</p>
            </div>

            <div class="input-container">
                <div class="input-group model-group">
                    <label for="model">AI Model Selection</label>
                    <div class="select-wrapper">
                        <select id="model" class="model-select">
                            <option value="">Choose AI Model</option>
                            <!-- <option value="gpt-4" data-rate="0.03">GPT-4 Turbo - ‚Çπ0.03/token</option>
                            <option value="gpt-3.5" data-rate="0.002">GPT-3.5 Turbo - ‚Çπ0.002/token</option>
                            <option value="claude-3" data-rate="0.025">Claude-3 Sonnet - ‚Çπ0.025/token</option>
                            <option value="gemini-pro" data-rate="0.015">Gemini Pro - ‚Çπ0.015/token</option>
                            <option value="llama-2" data-rate="0.001">Llama 2 70B - ‚Çπ0.001/token</option> -->
                        </select>
                        <div class="select-arrow">
                            <svg width="12" height="8" viewBox="0 0 12 8" fill="none">
                                <path d="M1 1.5L6 6.5L11 1.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                </div>

                <div class="input-group token-group">
                    <label for="tokens">Number of Tokens</label>
                    <input type="number" id="tokens" class="token-input" placeholder="Enter token quantity" min="1">
                </div>

                <button class="calculate-btn" id="calculateBtn">
                    <span class="btn-text">Calculate Price</span>
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M8 1L15 8L8 15M15 8H1" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="pricing-breakdown" id="pricingBreakdown">
            <div class="breakdown-header">
                <h2>Pricing Breakdown</h2>
                <div class="model-badge" id="selectedModelBadge"></div>
            </div>
            
            <div class="pricing-details">
                <div class="detail-row">
                    <span class="detail-label">Token Quantity</span>
                    <span class="detail-value" id="billTokens">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Rate per Token</span>
                    <span class="detail-value" id="tokenRate">‚Çπ0.00</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Subtotal</span>
                    <span class="detail-value" id="billPrice">‚Çπ0.00</span>
                </div>
                <div class="detail-row discount-row" id="discountRow" style="display: none;">
                    <span class="detail-label">
                        <span id="discountLabel">Discount Applied</span>
                        <span class="discount-source" id="discountSource"></span>
                    </span>
                    <span class="detail-value discount" id="discountAmount">-‚Çπ0.00</span>
                </div>
                <div class="divider"></div>
                <div class="detail-row total-row">
                    <span class="detail-label">Total Amount</span>
                    <span class="detail-value total" id="totalPrice">‚Çπ0.00</span>
                </div>
            </div>
            
            <!-- Coupon Code Section -->
            <div class="coupon-container">
                <div class="coupon-toggle" id="couponToggle">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" class="coupon-toggle-icon">
                        <path d="M9 12L11 14L15 10M12 3C16.97 3 21 6.043 21 9.5C21 10.5 20.5 11.5 19.5 12C20.5 12.5 21 13.5 21 14.5C21 17.957 16.97 21 12 21C7.03 21 3 17.957 3 14.5C3 13.5 3.5 12.5 4.5 12C3.5 11.5 3 10.5 3 9.5C3 6.043 7.03 3 12 3Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span>Have a coupon code?</span>
                </div>
                
                <div class="coupon-input-section" id="couponInputSection" style="display: none;">
                    <div class="coupon-input-wrapper">
                        <input type="text" id="couponInput" class="coupon-input" placeholder="Enter a coupon code" maxlength="20">
                        <button id="applyCouponBtn" class="apply-coupon-btn">
                            Apply
                        </button>
                    </div>
                    <div class="coupon-feedback" id="couponFeedback"></div>
                </div>
                
                <div class="applied-coupon-section" id="appliedCouponSection" style="display: none;">
                    <div class="coupon-success-message">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M20 6L9 17L4 12" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <span>Coupon code applied</span>
                    </div>
                    <div class="applied-coupon-badge" id="appliedCouponBadge">
                        <span id="appliedCouponCode"></span>
                        <button class="remove-coupon-btn">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M18 6L6 18M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="display: flex; justify-content: flex-end;">
                <button class="purchase-btn" id="purchaseBtn">
                    <span class="btn-text">Complete Purchase</span>
                    <svg class="btn-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M12 5L6.5 10.5L4 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg> 
                </button>
                <!-- <script>
                    // Order details variable to store purchase information
                    let orderDetails = {};
                    
                    // Add click event listener to purchase button
                    document.addEventListener('DOMContentLoaded', function() {
                        const purchaseBtn = document.getElementById('purchaseBtn');
                        
                        purchaseBtn.addEventListener('click', function() {
                            // Get current form values
                            const modelSelect = document.getElementById('model');
                            const tokensInput = document.getElementById('tokens');
                            const couponInput = document.getElementById('couponInput');
                            const appliedCouponCode = document.getElementById('appliedCouponCode');
                            
                            // Get applied offer code (if any)
                            const appliedOfferCard = document.querySelector('.offer-card.applied');
                            const offerCode = appliedOfferCard ? appliedOfferCard.querySelector('.offer-code').textContent : '';
                            
                            // Get actual model name from the AIModelPricingManager
                            let actualModelName = '';
                            if (modelSelect.value && window.AIModelPricingManager) {
                                const modelsData = window.AIModelPricingManager.getModelsData();
                                const selectedModel = modelsData.find(m => m.id === modelSelect.value);
                                actualModelName = selectedModel ? selectedModel.modelName : modelSelect.value;
                            } else {
                                actualModelName = modelSelect.value || '';
                            }
                            
                            // Prepare order details object
                            orderDetails = {
                                tokens: parseInt(tokensInput.value) || 0,
                                agentId: selectedAgent || '',
                                modelName: actualModelName,
                                couponCode: appliedCouponCode ? appliedCouponCode.textContent : (couponInput.value || ''),
                                offerCode: offerCode || ''
                            };
                            
                            // Log details in JSON format to console
                            console.log('=== PURCHASE BUTTON CLICKED ===');
                            console.log('Order Details (JSON):');
                            console.log(JSON.stringify(orderDetails, null, 2));
                            
                            // Also log individual details for clarity
                            console.log('Individual Details:');
                            console.log('Tokens:', orderDetails.tokens);
                            console.log('Agent ID:', orderDetails.agentId);
                            console.log('Model Name:', orderDetails.modelName);
                            console.log('Coupon Code:', orderDetails.couponCode);
                            console.log('Offer Code:', orderDetails.offerCode);
                            console.log('================================');
                            
                            // You can also display an alert with the JSON for testing
                            // alert('Order Details:\n' + JSON.stringify(orderDetails, null, 2));
                        });
                    });
                </script> -->
            
            
            </div>
        </div>

        <div class="offers-section">
            <div class="section-header">
                <h2>Exclusive Offers</h2>
                <p>Apply promotional codes to save on your token purchase</p>
            </div>
            
            <div class="offers-grid" id="offersGrid">
                <!-- <div class="offer-card premium" data-discount-type="percentage" data-discount-value="25" data-min-amount="1500">
                    <div class="offer-badge">Premium</div>
                    <h3>New Year Special</h3>
                    <p>Get 25% off on your first premium purchase. Valid for orders above ‚Çπ1,500.</p>
                    <div class="offer-details">
                        <span class="offer-code">NEWYEAR25</span>
                        <button class="apply-offer-btn">Apply Offer</button>
                    </div>
                </div>

                <div class="offer-card popular" data-discount-type="flat" data-discount-value="500" data-min-amount="2000">
                    <div class="offer-badge">Popular</div>
                    <h3>Bulk Purchase Discount</h3>
                    <p>Flat ‚Çπ500 off on bulk orders. Perfect for enterprise customers.</p>
                    <div class="offer-details">
                        <span class="offer-code">BULK500</span>
                        <button class="apply-offer-btn">Apply Offer</button>
                    </div>
                </div>

                <div class="offer-card standard" data-discount-type="percentage" data-discount-value="15" data-min-amount="500">
                    <div class="offer-badge">First Time</div>
                    <h3>Welcome Bonus</h3>
                    <p>15% discount for new customers. Start your AI journey with savings.</p>
                    <div class="offer-details">
                        <span class="offer-code">WELCOME15</span>
                        <button class="apply-offer-btn">Apply Offer</button>
                    </div>
                </div>

                <div class="offer-card weekend" data-discount-type="flat" data-discount-value="200" data-min-amount="800">
                    <div class="offer-badge">Limited</div>
                    <h3>Weekend Flash Sale</h3>
                    <p>‚Çπ200 off on weekend purchases. Valid until Sunday midnight.</p>
                    <div class="offer-details">
                        <span class="offer-code">WEEKEND200</span>
                        <button class="apply-offer-btn">Apply Offer</button>
                    </div>
                </div> -->
            </div>
        </div>

        <footer class="page-footer">
            <p>¬© 2025 AI Token Marketplace. All rights reserved. | Secure payments powered by advanced encryption</p>
        </footer>
    </div>
</body>
  <!-- <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
        // This is the JSON response you receive from your backend.
const apiResponse = {
    "success": true,
    "message": "Order created. Use the provided razorpayOrder to complete payment.",
    "razorpayOrder": {
        "id": "order_RG23t62zvsgHIz",
        "amount": 19000,
        "currency": "USD",
        "keyId": "rzp_test_RCor7m7EQVQcnW"
    },
    "receipt": "order_arjun_age1757536441632",
    "billing": {
        "username": "arjun_agent01",
        "agentId": "AGT-50345a8fdb40c313",
        "modelName": "gpt-4",
        "currency": "USD",
        "tokens": 800000,
        "perTokenPrice": 0.0003,
        "baseAmount": 240,
        "baseDiscount": {
            "applied": true,
            "amount": 45,
            "level": {
                "minOrderValue": 50,
                "maxOrderValue": 1000,
                "discountType": "flat",
                "discountValue": 45
            }
        },
        "promo": {
            "type": "offer",
            "code": "IND500",
            "discountAmount": 5
        },
        "totalDiscount": 50,
        "finalPayable": 190
    }
};

// Check if the order creation was successful before proceeding.
if (apiResponse.success && apiResponse.razorpayOrder) {

    // Extract the necessary data from the response object
    const orderData = apiResponse.razorpayOrder;
    const billingInfo = apiResponse.billing;

    const options = {
        // Essential details for the checkout
        key: orderData.keyId,
        amount: orderData.amount, // Amount in subunits
        currency: orderData.currency,
        order_id: orderData.id,

        // Optional: Customizing the checkout modal
        name: "Agent Services",
        description: `Purchase of ${billingInfo.tokens.toLocaleString()} tokens for ${billingInfo.modelName}`,
        image: "https://your-company-logo.com/logo.png", // Replace with your logo URL
        
        // Prefill user details (optional but recommended)
        prefill: {
            name: billingInfo.username,
            // email: "user@example.com", // You can get this from the user session
            // contact: "9999999999" // You can get this from the user session
        },
        
        // Notes to be attached to the payment (can be useful for your records)
        notes: {
            username: billingInfo.username,
            agent_id: billingInfo.agentId,
            tokens: billingInfo.tokens,
            promo_code: billingInfo.promo.code,
        },
        
        // Define the success handler
        handler: function(response) {
            // This function is called on successful payment
            alert("Payment successful! Payment ID: " + response.razorpay_payment_id);
            
            // Send the response back to your backend for verification
            console.log("Sending verification data to server:", response);
            
            // Example of a fetch call to your server
            // fetch('/verify-payment', {
            //   method: 'POST',
            //   headers: { 'Content-Type': 'application/json' },
            //   body: JSON.stringify(response)
            // })
            // .then(res => res.json())
            // .then(data => {
            //   if (data.success) {
            //     console.log("Payment successfully verified by server!");
            //   } else {
            //     console.error("Payment verification failed on server.");
            //   }
            // });
        },
        
        // Define a failure handler (optional but recommended)
        "modal.onclose": function() {
          console.log("Payment modal was closed.");
        },
        "modal.onOpen": function() {
          console.log("Payment modal was opened.");
        },
        "theme": {
            "color": "#3399cc"
        }
    };

    // Create a new Razorpay instance and open the checkout
    const rzp1 = new Razorpay(options);
    rzp1.on('payment.failed', function (response){
        alert("Payment failed: " + response.error.description);
        console.error("Payment failed with error code: " + response.error.code);
        console.error("Error description: " + response.error.description);
        console.error("Contact support with ID: " + response.error.source + " - " + response.error.reason);
    });
    rzp1.open();
    
} else {
    // Handle the case where the backend call was not successful
    console.error("Failed to create Razorpay order:", apiResponse.message);
    alert("Could not create the payment order. Please try again later.");
}
    </script> -->

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  let orderDetails = {};

  document.addEventListener("DOMContentLoaded", function () {
    const purchaseBtn = document.getElementById("purchaseBtn");

    purchaseBtn.addEventListener("click", async function () {
                console.log("abiobufsbivbaidfbvabifbivbaibfibi");

        console.log(window.selectedAgent);
        
      try {
        // Get form values
        const modelSelect = document.getElementById("model");
        const tokensInput = document.getElementById("tokens");
        const couponInput = document.getElementById("couponInput");
        const appliedCouponCode = document.getElementById("appliedCouponCode");

        const appliedOfferCard = document.querySelector(".offer-card.applied");
        const offerCode = appliedOfferCard
          ? appliedOfferCard.querySelector(".offer-code").textContent
          : "";

        // Get actual model name
        let actualModelName = "";
        if (modelSelect.value && window.AIModelPricingManager) {
          const modelsData = window.AIModelPricingManager.getModelsData();
          const selectedModel = modelsData.find((m) => m.id === modelSelect.value);
          actualModelName = selectedModel ? selectedModel.modelName : modelSelect.value;
        } else {
          actualModelName = modelSelect.value || "";
        }

        // Prepare order details
        orderDetails = {
          tokens: parseInt(tokensInput.value) || 0,
          agentId: window.selectedAgent || "",
          modelName: actualModelName,
          couponCode: appliedCouponCode
            ? appliedCouponCode.textContent
            : couponInput.value || "",
          offerCode: offerCode || "",
        };

        console.log("üì¶ Order Details:", orderDetails);

        // Step 1 ‚Üí Call backend to create Razorpay order
        const createRes = await fetch("/create_order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(orderDetails),
          credentials: "include", // send cookies for JWT auth
        });

        const createData = await createRes.json();
        if (!createData.success || !createData.razorpayOrder) {
          alert("‚ùå Failed to create order: " + (createData.error || "Unknown error"));
          return;
        }

        const razorpayOrder = createData.razorpayOrder;
        console.log("‚úÖ Razorpay Order:", razorpayOrder);

        // Step 2 ‚Üí Open Razorpay Checkout
        const options = {
          key: razorpayOrder.keyId,
          amount: razorpayOrder.amount,
          currency: razorpayOrder.currency,
          order_id: razorpayOrder.id,
          name: "Your Company",
          description: "AI Model Token Purchase",
          handler: async function (response) {
            console.log("üí≥ Razorpay Payment Response:", response);

            // Step 3 ‚Üí Confirm payment with backend
            const confirmRes = await fetch("/confirm_payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_order_id: response.razorpay_order_id,
              }),
              credentials: "include",
            });

            const confirmData = await confirmRes.json();
            if (confirmData.success) {
              alert("üéâ Payment successful! Tokens allotted.");
              location.reload();
            } else {
              alert("‚ùå Payment confirmation failed: " + (confirmData.error || "Unknown error"));
              location.reload();
            }
          },
          theme: {
            color: "#3399cc",
          },
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error("‚ö†Ô∏è Error in purchase flow:", err);
        alert("Something went wrong. Please try again.");
      }
    });
  });
</script>

</html>